- Memory Manager controls allocation of virtual memory
- Vm... access rights are required for different operations

## NtVirtualMemory Commands
```powershell
#Lists all memory regions in use by current process or specified memory region with -Address
Get-NtVirtualMemory

Add-NtVirtualMemory -Size 1000 -Protection ReadWrite

Read-NtVirtualMemory 
Read-NtVirtualMemory -Address $addr -Size 4 | Out-HexDump

Write-NtVirtualMemory -Address $addr -Data @(1,2,3,4)

Set-NtVirtualMemory -Address $addr -Protection ExecuteRead -Size 4

Remove-NtVirtualMemory -Address $addr
```

### Virtual Memory States
1. Commit - virtual memory region is allocated and available
2. Reserve - allocated but no backing memory (crashes on use)
3. Free -  unallocated and unused (crashes on use)

## Section Objects
- Kernel type that implements memory mapped files
- Useful  for reading a file as if it wer all read into memory
- Sharing memory between processes with modifications shared
![[Creating a section and mapping it to memory.png]]
The protection to map a section object depends on protection specified during creation of the section object and access granted to section handle
- Note that MapWrite without MapRead is insufficient for writing
![[Creating and mapping a section object.png]]
Query to find mapped sections backed by files
```powershell
Get-NtVirtualMemory -Type Mapped | Where-Object Name -ne ""
```

Three section types
1. Anonymous
2. Mapped
3. Image - Simplify mapping of EXEs to memory by not requiring execute protections (any works) and the section is made of multiple smaller mapped regions
